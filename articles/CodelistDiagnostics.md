# Codelist diagnostics

## Introduction

In this example we’re going to summarise the characteristics of
individuals with an ankle sprain, ankle fracture, forearm fracture, a
hip fracture and different measurements using the Eunomia synthetic
data.

We’ll begin by creating our study cohorts.

``` r
library(CDMConnector)
library(CohortConstructor)
library(CodelistGenerator)
library(PhenotypeR)
library(MeasurementDiagnostics)
library(dplyr)
library(ggplot2)

con <- DBI::dbConnect(duckdb::duckdb(), 
                      CDMConnector::eunomiaDir("synpuf-1k", "5.3"))
cdm <- CDMConnector::cdmFromCon(con = con, 
                                cdmName = "Eunomia Synpuf",
                                cdmSchema   = "main",
                                writeSchema = "main", 
                                achillesSchema = "main")

cdm$injuries <- conceptCohort(cdm = cdm,
  conceptSet = list(
    "ankle_sprain" = 81151,
    "ankle_fracture" = 4059173,
    "forearm_fracture" = 4278672,
    "hip_fracture" = 4230399,
    "measurements_cohort" = c(40660437L, 2617206L, 4034850L,  2617239L, 4098179L)
  ),
  name = "injuries")
cdm$injuries |> 
  glimpse()
#> Rows: ??
#> Columns: 4
#> Database: DuckDB 1.4.4 [unknown@Linux 6.11.0-1018-azure:R 4.5.2//tmp/RtmpBe8aPE/file21ac1e8319d6.duckdb]
#> $ cohort_definition_id <int> 5, 5, 5, 5, 5, 5, 5, 5, 2, 5, 5, 5, 5, 5, 5, 5, 5…
#> $ subject_id           <int> 271, 230, 1275, 507, 434, 22, 364, 815, 450, 463,…
#> $ cohort_start_date    <date> 2010-04-03, 2008-07-24, 2008-09-24, 2010-07-27, …
#> $ cohort_end_date      <date> 2010-04-03, 2008-07-24, 2008-09-24, 2010-07-27, …
```

## Summarising code use

To get a good understanding of the codes we’ve used to define our
cohorts we can use the
[`codelistDiagnostics()`](https://ohdsi.github.io/PhenotypeR/reference/codelistDiagnostics.md)
function.

``` r
code_diag <- codelistDiagnostics(cdm$injuries)
```

Codelist diagnostics builds on
[CodelistGenerator](https://darwin-eu.github.io/CodelistGenerator/) and
[MeasurementDiagnostics](https://ohdsi.github.io/MeasurementDiagnostics/)
R packages to perform the following analyses:

- **Achilles code use:** Which summarises the counts of our codes in our
  database based on achilles results using
  [summariseAchillesCodeUse()](https://darwin-eu.github.io/CodelistGenerator/reference/summariseAchillesCodeUse.html).
- **Orphan code use:** Orphan codes refer to codes that we did not
  include in our cohort definition, but that have any relationship with
  the codes in our codelist. So, although many can be false positives,
  we may identify some codes that we may want to use in our cohort
  definitions. This analysis uses
  [summariseOrphanCodes()](https://darwin-eu.github.io/CodelistGenerator/reference/summariseOrphanCodes.html).
- **Cohort code use:** Summarises the cohort code use in our cohort
  using
  [summariseCohortCodeUse()](https://darwin-eu.github.io/CodelistGenerator/reference/summariseCohortCodeUse.html).
- **Measurement diagnostics:** If any of the concepts used in our
  codelist is a measurement, it summarises its code use using
  [summariseCohortMeasurementUse()](https://ohdsi.github.io/MeasurementDiagnostics/reference/summariseCohortMeasurementUse.html).

The output of a function is a summarised result table.

### Add codelist attribute

Some cohorts that may be created manually may not have the codelists
recorded in the `cohort_codelist` attribute. The package has a utility
function to record a codelist in a `cohort_table` object:

``` r
cohortCodelist(cdm$injuries, cohortId = 1)
#> 
#> - ankle_fracture (1 codes)
cdm$injuries <- cdm$injuries |>
  addCodelistAttribute(codelist = list(new_codelist = c(1L, 2L)), cohortName = "ankle_fracture")
cohortCodelist(cdm$injuries, cohortId = 1)
#> 
#> - new_codelist (2 codes)
```

## Visualise the results

We will now use different functions to visualise the results generated
by CohortDiagnostics. Notice that these functions are from
[CodelistGenerator](https://darwin-eu.github.io/CodelistGenerator/) and
[MeasurementDiagnostics](https://ohdsi.github.io/MeasurementDiagnostics/)
R packages packages.

### Achilles code use

``` r
tableAchillesCodeUse(code_diag)
```

[TABLE]

### Orphan code use

``` r
tableOrphanCodes(code_diag)
```

[TABLE]

### Cohort code use

``` r
tableCohortCodeUse(code_diag)
```

[TABLE]

### Measurement timings

``` r
tableMeasurementSummary(code_diag)
```

| CDM name            | Cohort name         | Variable name            | Estimate name        | Estimate value       |
|---------------------|---------------------|--------------------------|----------------------|----------------------|
| measurements_cohort |                     |                          |                      |                      |
| Eunomia Synpuf      | measurements_cohort | Number records           | N                    | 1,820                |
|                     |                     | Number subjects          | N                    | 255                  |
|                     |                     | Time (days)              | Median \[Q25 - Q75\] | 150 \[19 - 356\]     |
|                     |                     |                          | Range                | 0 to 930             |
|                     |                     | Measurements per subject | Median \[Q25 - Q75\] | 1.00 \[1.00 - 2.00\] |
|                     |                     |                          | Range                | 1.00 to 10.00        |

``` r
plotMeasurementSummary(code_diag)
```

![](CodelistDiagnostics_files/figure-html/unnamed-chunk-9-1.png)

### Measurement value as concept

``` r
tableMeasurementValueAsConcept(code_diag)
```

| CDM name            | Cohort name         | Concept name                                                                                                                                                                                                                  | Concept ID | Source concept name                                                                                                                                                                                                           | Source concept ID | Domain ID   | Value as concept name | Value as concept ID | Estimate name | Estimate value  |
|---------------------|---------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------|-------------|-----------------------|---------------------|---------------|-----------------|
| measurements_cohort |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                       |                     |               |                 |
| unknown             | measurements_cohort | overall                                                                                                                                                                                                                       | overall    | overall                                                                                                                                                                                                                       | overall           | overall     | No matching concept   | 0                   | N (%)         | 1,820 (100.00%) |
|                     |                     | Prostate cancer screening; prostate specific antigen test (psa)                                                                                                                                                               | 2617206    | Prostate cancer screening; prostate specific antigen test (psa)                                                                                                                                                               | 2617206           | Measurement | No matching concept   | 0                   | N (%)         | 730 (100.00%)   |
|                     |                     | Screening cytopathology, cervical or vaginal (any reporting system), collected in preservative fluid, automated thin layer preparation, with screening by automated system and manual rescreening under physician supervision | 2617239    | Screening cytopathology, cervical or vaginal (any reporting system), collected in preservative fluid, automated thin layer preparation, with screening by automated system and manual rescreening under physician supervision | 2617239           | Measurement | No matching concept   | 0                   | N (%)         | 260 (100.00%)   |
|                     |                     | Laboratory test                                                                                                                                                                                                               | 4034850    | Laboratory examination ordered as part of a routine general medical examination                                                                                                                                               | 44823881          | Measurement | No matching concept   | 0                   | N (%)         | 70 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Pre-procedural laboratory examination                                                                                                                                                                                         | 44827407          | Measurement | No matching concept   | 0                   | N (%)         | 50 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Laboratory examination, unspecified                                                                                                                                                                                           | 44835527          | Measurement | No matching concept   | 0                   | N (%)         | 80 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Other laboratory examination                                                                                                                                                                                                  | 44835528          | Measurement | No matching concept   | 0                   | N (%)         | 65 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Laboratory examination                                                                                                                                                                                                        | 44836706          | Measurement | No matching concept   | 0                   | N (%)         | 240 (100.00%)   |
|                     |                     | Immunology laboratory test                                                                                                                                                                                                    | 4098179    | Other and unspecified nonspecific immunological findings                                                                                                                                                                      | 44830461          | Measurement | No matching concept   | 0                   | N (%)         | 45 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Antibody response examination                                                                                                                                                                                                 | 44830850          | Measurement | No matching concept   | 0                   | N (%)         | 55 (100.00%)    |
|                     |                     | Drug screen, qualitative; multiple drug classes by high complexity test method (e.g., immunoassay, enzyme assay), per patient encounter                                                                                       | 40660437   | Drug screen, qualitative; multiple drug classes by high complexity test method (e.g., immunoassay, enzyme assay), per patient encounter                                                                                       | 40660437          | Measurement | No matching concept   | 0                   | N (%)         | 225 (100.00%)   |

``` r
plotMeasurementValueAsConcept(code_diag)
```

![](CodelistDiagnostics_files/figure-html/unnamed-chunk-11-1.png)

### Measurement value as numeric

``` r
tableMeasurementValueAsNumber(code_diag)
```

| CDM name            | Cohort name         | Concept name                                                                                                                                                                                                                  | Concept ID | Source concept name                                                                                                                                                                                                           | Source concept ID | Domain ID   | Unit concept name   | Unit concept ID | Estimate name        | Estimate value  |
|---------------------|---------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------|-------------|---------------------|-----------------|----------------------|-----------------|
| measurements_cohort |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 |                      |                 |
| Eunomia Synpuf      | measurements_cohort | overall                                                                                                                                                                                                                       | overall    | overall                                                                                                                                                                                                                       | overall           | overall     | No matching concept | 0               | N                    | 1,820           |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 1,820 (100.00%) |
|                     |                     | Prostate cancer screening; prostate specific antigen test (psa)                                                                                                                                                               | 2617206    | Prostate cancer screening; prostate specific antigen test (psa)                                                                                                                                                               | 2617206           | Measurement | No matching concept | 0               | N                    | 730             |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 730 (100.00%)   |
|                     |                     | Screening cytopathology, cervical or vaginal (any reporting system), collected in preservative fluid, automated thin layer preparation, with screening by automated system and manual rescreening under physician supervision | 2617239    | Screening cytopathology, cervical or vaginal (any reporting system), collected in preservative fluid, automated thin layer preparation, with screening by automated system and manual rescreening under physician supervision | 2617239           | Measurement | No matching concept | 0               | N                    | 260             |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 260 (100.00%)   |
|                     |                     | Laboratory test                                                                                                                                                                                                               | 4034850    | Laboratory examination ordered as part of a routine general medical examination                                                                                                                                               | 44823881          | Measurement | No matching concept | 0               | N                    | 70              |
|                     |                     |                                                                                                                                                                                                                               |            | Pre-procedural laboratory examination                                                                                                                                                                                         | 44827407          | Measurement | No matching concept | 0               | N                    | 50              |
|                     |                     |                                                                                                                                                                                                                               |            | Laboratory examination, unspecified                                                                                                                                                                                           | 44835527          | Measurement | No matching concept | 0               | N                    | 80              |
|                     |                     |                                                                                                                                                                                                                               |            | Other laboratory examination                                                                                                                                                                                                  | 44835528          | Measurement | No matching concept | 0               | N                    | 65              |
|                     |                     |                                                                                                                                                                                                                               |            | Laboratory examination                                                                                                                                                                                                        | 44836706          | Measurement | No matching concept | 0               | N                    | 240             |
|                     |                     |                                                                                                                                                                                                                               |            | Laboratory examination ordered as part of a routine general medical examination                                                                                                                                               | 44823881          | Measurement | No matching concept | 0               | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 70 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Pre-procedural laboratory examination                                                                                                                                                                                         | 44827407          | Measurement | No matching concept | 0               | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 50 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Laboratory examination, unspecified                                                                                                                                                                                           | 44835527          | Measurement | No matching concept | 0               | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 80 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Other laboratory examination                                                                                                                                                                                                  | 44835528          | Measurement | No matching concept | 0               | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 65 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Laboratory examination                                                                                                                                                                                                        | 44836706          | Measurement | No matching concept | 0               | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 240 (100.00%)   |
|                     |                     | Drug screen, qualitative; multiple drug classes by high complexity test method (e.g., immunoassay, enzyme assay), per patient encounter                                                                                       | 40660437   | Drug screen, qualitative; multiple drug classes by high complexity test method (e.g., immunoassay, enzyme assay), per patient encounter                                                                                       | 40660437          | Measurement | No matching concept | 0               | N                    | 225             |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 225 (100.00%)   |
|                     |                     | Immunology laboratory test                                                                                                                                                                                                    | 4098179    | Other and unspecified nonspecific immunological findings                                                                                                                                                                      | 44830461          | Measurement | No matching concept | 0               | N                    | 45              |
|                     |                     |                                                                                                                                                                                                                               |            | Antibody response examination                                                                                                                                                                                                 | 44830850          | Measurement | No matching concept | 0               | N                    | 55              |
|                     |                     |                                                                                                                                                                                                                               |            | Other and unspecified nonspecific immunological findings                                                                                                                                                                      | 44830461          | Measurement | No matching concept | 0               | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 45 (100.00%)    |
|                     |                     |                                                                                                                                                                                                                               |            | Antibody response examination                                                                                                                                                                                                 | 44830850          | Measurement | No matching concept | 0               | Median \[Q25 - Q75\] | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q05 - Q95            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Q01 - Q99            | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Range                | –               |
|                     |                     |                                                                                                                                                                                                                               |            |                                                                                                                                                                                                                               |                   |             |                     |                 | Missing value, N (%) | 55 (100.00%)    |

``` r
plotMeasurementValueAsNumber(code_diag)
```

![](CodelistDiagnostics_files/figure-html/unnamed-chunk-13-1.png)
