<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Phenotype expectations • PhenotypeR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Phenotype expectations">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PhenotypeR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Main functionality</h6></li>
    <li><a class="dropdown-item" href="../articles/PhenotypeDiagnostics.html">PhenotypeDiagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/PhenotypeExpectations.html">PhenotypeExpectations</a></li>
    <li><a class="dropdown-item" href="../articles/ShinyDiagnostics.html">ShinyDiagnostics</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Individual functions</h6></li>
    <li><a class="dropdown-item" href="../articles/DatabaseDiagnostics.html">DatabaseDiagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/CodelistDiagnostics.html">CodelistDiagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/CohortDiagnostics.html">CohortDiagnostics</a></li>
    <li><a class="dropdown-item" href="../articles/PopulationDisgnostics.html">PopulationDisgnostics</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://dpa-pde-oxford.shinyapps.io/PhenotypeRShiny/">PhenotypeR shiny App</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/PhenotypeR" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="phenotypeExpectations_files/core-js-2.5.3/shim.min.js"></script><script src="phenotypeExpectations_files/react-18.2.0/react.min.js"></script><script src="phenotypeExpectations_files/react-18.2.0/react-dom.min.js"></script><script src="phenotypeExpectations_files/reactwidget-2.0.0/react-tools.js"></script><link href="phenotypeExpectations_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="phenotypeExpectations_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="phenotypeExpectations_files/reactable-0.4.4/reactable.css" rel="stylesheet">
<script src="phenotypeExpectations_files/reactable-binding-0.4.4/reactable.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Phenotype expectations</h1>
            
      

      <div class="d-none name"><code>phenotypeExpectations.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="comparing-phenotype-diagnostic-results-against-expectations">Comparing phenotype diagnostic results against expectations<a class="anchor" aria-label="anchor" href="#comparing-phenotype-diagnostic-results-against-expectations"></a>
</h2>
<p>We use PhenotypeR to help assess the research readiness of a set of
study cohorts. To help make such assessments it can help to have an
explicit set of expectations to compare our results. For example, is the
age of our study cohort similar to what would be expected? Is the
proportion of the cohort that is male vs female similar to what would be
expected based on what we know about the phenotype of interest?</p>
<div class="section level3">
<h3 id="custom-expectations">Custom expectations<a class="anchor" aria-label="anchor" href="#custom-expectations"></a>
</h3>
<p>We can define a set of custom expectations. So that we can visualise
these easily using the <code><a href="../reference/tableCohortExpectations.html">tableCohortExpectations()</a></code> function,
we will create a tibble with the following columns: name (cohort name),
estimate (the estimate of interest), value (our expectation on the value
we should see in our results). As an example, say we have one cohort
called “knee_osteoarthritis” and another called “knee_replacement”. We
could create expectations about median age of the cohort and the
proportion that is male like so.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/PhenotypeR/">PhenotypeR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">knee_oa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>cohort_name <span class="op">=</span> <span class="st">"knee_osteoarthritis"</span>,</span>
<span>                  estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Median age"</span>, <span class="st">"Proportion male"</span><span class="op">)</span>,</span>
<span>                  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"60 to 65"</span>, <span class="st">"45%"</span><span class="op">)</span>,</span>
<span>                  source <span class="op">=</span> <span class="st">"Clinician"</span><span class="op">)</span></span>
<span><span class="va">knee_replacement</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>cohort_name <span class="op">=</span> <span class="st">"knee_replacement"</span>,</span>
<span>                           estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Median age"</span>, <span class="st">"Proportion male"</span><span class="op">)</span>,</span>
<span>                           value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"65 to 70"</span>, <span class="st">"50%"</span><span class="op">)</span>,</span>
<span>                           source <span class="op">=</span> <span class="st">"Clinician"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">expectations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">knee_oa</span>, <span class="va">knee_replacement</span><span class="op">)</span></span></code></pre></div>
<p>Now we have our structured expectaitions, we can quickly create a
summary of them. We’ll see in the next vignette how we can then also
include them in our shiny app.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tableCohortExpectations.html">tableCohortExpectations</a></span><span class="op">(</span><span class="va">expectations</span><span class="op">)</span></span></code></pre></div>
<div class="reactable html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"cohort_name":["knee_osteoarthritis","knee_replacement"]},"columns":[{"id":".details","name":"","type":null,"sortable":false,"resizable":false,"filterable":false,"searchable":false,"width":45,"align":"center","details":[{"name":"Fragment","attribs":[],"children":[{"name":"div","attribs":{"style":{"padding":"10px","background-color":"#f9f9f9"}},"children":[{"name":"div","attribs":{"style":{"padding":"6px 10px","margin-bottom":"6px","border-bottom":"1px solid #ccc"}},"children":[{"name":"span","attribs":{"style":{"font-weight":"bold"}},"children":["Median age"]},": 60 to 65",{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":[" (Source: "]},{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":["Clinician"]},{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":[")"]}]},{"name":"div","attribs":{"style":{"padding":"6px 10px","margin-bottom":"6px","border-bottom":"1px solid #ccc"}},"children":[{"name":"span","attribs":{"style":{"font-weight":"bold"}},"children":["Proportion male"]},": 45%",{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":[" (Source: "]},{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":["Clinician"]},{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":[")"]}]}]}]},{"name":"Fragment","attribs":[],"children":[{"name":"div","attribs":{"style":{"padding":"10px","background-color":"#f9f9f9"}},"children":[{"name":"div","attribs":{"style":{"padding":"6px 10px","margin-bottom":"6px","border-bottom":"1px solid #ccc"}},"children":[{"name":"span","attribs":{"style":{"font-weight":"bold"}},"children":["Median age"]},": 65 to 70",{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":[" (Source: "]},{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":["Clinician"]},{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":[")"]}]},{"name":"div","attribs":{"style":{"padding":"6px 10px","margin-bottom":"6px","border-bottom":"1px solid #ccc"}},"children":[{"name":"span","attribs":{"style":{"font-weight":"bold"}},"children":["Proportion male"]},": 50%",{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":[" (Source: "]},{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":["Clinician"]},{"name":"span","attribs":{"style":{"font-style":"italic"}},"children":[")"]}]}]}]}]},{"id":"cohort_name","name":"cohort_name","type":"character"}],"resizable":true,"onClick":"expand","nowrap":true,"className":"packages-table","rowStyle":{"cursor":"pointer"},"theme":{"cellPadding":"8px 12px","headerStyle":{"display":"none"}},"dataKey":"0e1ac82811c01196a0c7fadde1bbc9a8"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level3">
<h3 id="llm-based-expectations-via-ellmer">LLM based expectations via ellmer<a class="anchor" aria-label="anchor" href="#llm-based-expectations-via-ellmer"></a>
</h3>
<p>The custom expectations created above might be based on our (or a
friendly colleagues’) clinical knowledge. This though will have required
access to the requisite clinical knowledge and, especially if we have
many cohorts and/ or start considering the many different estimates that
are generated, will have been rather time-consuming.</p>
<p>To speed up the process we can use an LLM to help us generate our
expectations. We could use this to create a custom set like above. But
PhenotypeR also provides the <code><a href="../reference/getCohortExpectations.html">getCohortExpectations()</a></code> which
will generate a set of expectations using an LLM available via the
ellmer R package.</p>
<p>Here for example we’ll use Google Gemini to populate our
expectations. Notice that you may need first to create a Gemini API to
run the example. You can do that following this link: <a href="https://aistudio.google.com/app/apikey" class="external-link uri">https://aistudio.google.com/app/apikey</a>.</p>
<p>And adding the API in your R environment:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/edit.html" class="external-link">edit_r_environ</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add your API in your R environment:</span></span>
<span><span class="va">GEMINI_API_KEY</span> <span class="op">=</span> <span class="st">"your API"</span></span>
<span></span>
<span><span class="co"># Restrart R</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ellmer.tidyverse.org" class="external-link">ellmer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_google_gemini.html" class="external-link">chat_google_gemini</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/getCohortExpectations.html">getCohortExpectations</a></span><span class="op">(</span>chat <span class="op">=</span> <span class="va">chat</span>, </span>
<span>                      phenotypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ankle sprain"</span>, <span class="st">"prostate cancer"</span>, <span class="st">"morphine"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/tableCohortExpectations.html">tableCohortExpectations</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Instead of passing our cohort names, we could instead pass our
results set from <code><a href="../reference/phenotypeDiagnostics.html">phenotypeDiagnostics()</a></code> instead. In this
case we’ll automatically get expectations for each of the study cohorts
in our results.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r.duckdb.org/" class="external-link">duckdb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darwin-eu.github.io/CDMConnector/" class="external-link">CDMConnector</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/CohortConstructor/" class="external-link">CohortConstructor</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>, dbdir <span class="op">=</span> <span class="fu"><a href="https://darwin-eu.github.io/CDMConnector/reference/eunomiaDir.html" class="external-link">eunomiaDir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/CDMConnector/reference/cdmFromCon.html" class="external-link">cdmFromCon</a></span><span class="op">(</span></span>
<span>    con <span class="op">=</span> <span class="va">con</span>, cdmSchema <span class="op">=</span> <span class="st">"main"</span>, writeSchema <span class="op">=</span> <span class="st">"main"</span>, cdmName <span class="op">=</span> <span class="st">"Eunomia"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"ankle_sprain"</span> <span class="op">=</span> <span class="fl">81151</span>,</span>
<span>              <span class="st">"prostate_cancer"</span> <span class="op">=</span> <span class="fl">4163261</span>,</span>
<span>              <span class="st">"morphine"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1110410L</span>, <span class="fl">35605858L</span>, <span class="fl">40169988L</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">my_cohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ohdsi.github.io/CohortConstructor/reference/conceptCohort.html" class="external-link">conceptCohort</a></span><span class="op">(</span>cdm <span class="op">=</span> <span class="va">cdm</span>,</span>
<span>                                 conceptSet <span class="op">=</span> <span class="va">codes</span>,</span>
<span>                                 exit <span class="op">=</span> <span class="st">"event_end_date"</span>,</span>
<span>                                 name <span class="op">=</span> <span class="st">"my_cohort"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diag_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phenotypeDiagnostics.html">phenotypeDiagnostics</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">my_cohort</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/getCohortExpectations.html">getCohortExpectations</a></span><span class="op">(</span>chat <span class="op">=</span> <span class="va">chat</span>, </span>
<span>                      phenotypes <span class="op">=</span> <span class="va">diag_results</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/tableCohortExpectations.html">tableCohortExpectations</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>It is important to note the importance of a descriptive cohort name.
These are the names passed to the LLM and so the more informative the
name, the better we can expect the LLM to do.</p>
<p>It should also go without saying that we should not treat the output
of the LLM as the unequivocal truth. While LLM expectations may well
prove an important starting point, clinical judgement and knowledge of
the data source at hand will still be vital in appropriately
interpretting our results.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Edward Burn, Marti Catala, Xihang Chen, Marta Alcalde-Herraiz, Albert Prats-Uribe.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
